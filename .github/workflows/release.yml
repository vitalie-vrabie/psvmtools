name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.9)'
        required: true

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Inno Setup
      shell: pwsh
      run: |
        choco install innosetup -y
    - name: Ensure dist/ is not committed
      shell: pwsh
      run: |
        Write-Host "Note: dist/ contains build artifacts and must NOT be committed to the repository. Release workflow will upload artifacts separately."
        $tracked = git ls-files 'dist/*' 2>$null | Out-String
        if ($tracked.Trim()) {
          Write-Host "ERROR: Found tracked files under dist/:" -ForegroundColor Red
          git ls-files 'dist/*' | ForEach-Object { Write-Host "  $_" }
          throw 'Tracked files in dist/ detected. Remove them from the repository and do not commit build artifacts.'
        } else {
          Write-Host "No tracked files under dist/ — OK." -ForegroundColor Green
        }
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Build GUI Application (self-contained)
      shell: pwsh
      run: |
        dotnet publish PSHVTools.GUI/PSHVToolsShell/PSHVToolsShell.csproj -c Release -r win-x64 -f net10.0-windows --self-contained true
        
    - name: Copy GUI Executable to Dist
      shell: pwsh
      run: |
        Copy-Item "PSHVTools.GUI/PSHVToolsShell/bin/Release/net10.0-windows/win-x64/publish/PSHVToolsShell.exe" "dist/"
        Copy-Item "PSHVTools.GUI/PSHVToolsShell/bin/Release/net10.0-windows/win-x64/publish/*" "dist/" -Recurse -Force
        
    - name: Update Documentation and Samples
      shell: pwsh
      run: |
        # Update docs and samples before release
        # This step ensures documentation is current and samples are updated
        Write-Host "Updating documentation and samples..."
        # Add commands here to update docs, e.g., regenerate README, update samples, etc.
        # For now, this is a placeholder - implement specific update logic as needed
        
    - name: Rebuild Installer (if needed)
      shell: pwsh
      run: |
        # Rebuild installer to ensure it's up-to-date with latest changes
        Write-Host "Rebuilding installer..."
        ./build.ps1 -Verbose

    - name: Generate Checksums
      shell: pwsh
      run: |
        $hash = Get-FileHash "dist/PSHVTools-Setup.exe" -Algorithm SHA256
        "$($hash.Hash)  PSHVTools-Setup.exe" | Out-File "dist/PSHVTools-Setup.exe.sha256"
        
    - name: Read Release Notes
      id: release_notes
      shell: pwsh
      run: |
        $content = Get-Content RELEASE_NOTES.md -Raw
        # Escape content for GitHub output
        $content = $content -replace "`r`n", "%0A"
        Write-Host "notes=$content" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        
    - name: Check if Stable Release
      id: check_stable
      shell: pwsh
      run: |
        # Determine whether this release should be marked as a prerelease.
        # Rules:
        #  - If the tag contains a prerelease identifier (e.g. 1.2.3-rc1 or 1.2.3-beta), mark prerelease.
        #  - Otherwise, compare the tag (without leading 'v') to the canonical release version in version.json.
        #    If they differ, treat as prerelease. If they match exactly, treat as stable.
        $versionJson = Get-Content version.json | ConvertFrom-Json
        $releaseVersion = $versionJson.version
        $tag = $env:GITHUB_REF_NAME -replace '^v', ''

        $isPrerelease = $false
        if ($tag -match '-') {
            $isPrerelease = $true
        } elseif ($tag -ne $releaseVersion) {
            $isPrerelease = $true
        }

        # Emit output as lowercase 'true'/'false' strings for GitHub Actions
        $out = $isPrerelease.ToString().ToLower()
        Write-Host "is_prerelease=$out" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/PSHVTools-Setup.exe
          dist/PSHVTools-Setup.exe.sha256
          dist/PSHVToolsShell.exe
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: ${{ eq( steps.check_stable.outputs.is_prerelease, 'true') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
