<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" 
           Name="PSHVTools" 
           Language="1033" 
           Version="1.0.0.0" 
           Manufacturer="Vitalie Vrabie" 
           UpgradeCode="A3C5E8F1-9D4B-4A2C-B6E7-8F3D9C1A5B2E">
    
    <Package InstallerVersion="200" 
             Compressed="yes" 
             InstallScope="perMachine"
             Platform="x64"
             Description="PSHVTools - PowerShell Hyper-V Tools"
             Comments="Hyper-V VM backup utilities using checkpoints and 7-Zip compression" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    
    <MediaTemplate EmbedCab="yes" />

    <!-- Add/Remove Programs properties -->
    <Property Id="ARPHELPLINK" Value="https://github.com/vitalie-vrabie/pshvtools" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/vitalie-vrabie/pshvtools" />

    <!-- Check for PowerShell 5.1+ -->
    <Property Id="POWERSHELLVERSION">
      <RegistrySearch Id="PowerShellVersionSearch" 
                      Root="HKLM" 
                      Key="SOFTWARE\Microsoft\PowerShell\3\PowerShellEngine" 
                      Name="PowerShellVersion" 
                      Type="raw" />
    </Property>
    
    <Condition Message="PowerShell 5.1 or later is required.">
      <![CDATA[Installed OR POWERSHELLVERSION >= "5.1"]]>
    </Condition>

    <!-- Feature structure -->
    <Feature Id="ProductFeature" 
             Title="PSHVTools Core" 
             Description="Core PSHVTools files and PowerShell module" 
             Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="PowerShellModuleComponents" />
      <ComponentRef Id="ApplicationShortcut" />
    </Feature>

    <!-- Directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- Program Files installation -->
      <Directory Id="ProgramFilesFolder">
        <!-- Application folder -->
        <Directory Id="INSTALLFOLDER" Name="PSHVTools">
          <Directory Id="DocsFolder" Name="docs" />
        </Directory>
        
        <!-- PowerShell Modules folder (standard location) -->
        <Directory Id="WindowsPowerShellFolder" Name="WindowsPowerShell">
          <Directory Id="ModulesFolder" Name="Modules">
            <Directory Id="HvbakModuleFolder" Name="hvbak" />
          </Directory>
        </Directory>
      </Directory>

      <!-- Start Menu -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="PSHVTools" />
      </Directory>
    </Directory>

    <!-- Components for main installation -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="HvbakScript" Guid="B1C2D3E4-5F6A-7B8C-9D0E-1F2A3B4C5D6E" Win64="yes">
        <File Id="HvbakPs1" Source="hvbak.ps1" KeyPath="yes" />
      </Component>
      <Component Id="HvbakModule" Guid="C2D3E4F5-6A7B-8C9D-0E1F-2A3B4C5D6E7F" Win64="yes">
        <File Id="HvbakPsm1" Source="hvbak.psm1" KeyPath="yes" />
      </Component>
      <Component Id="HvbakManifest" Guid="D3E4F5A6-7B8C-9D0E-1F2A-3B4C5D6E7F8A" Win64="yes">
        <File Id="HvbakPsd1" Source="hvbak.psd1" KeyPath="yes" />
      </Component>
      <Component Id="Documentation" Guid="E4F5A6B7-8C9D-0E1F-2A3B-4C5D6E7F8A9B" Win64="yes">
        <File Id="QuickStart" Source="QUICKSTART.md" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Components for PowerShell module installation -->
    <ComponentGroup Id="PowerShellModuleComponents" Directory="HvbakModuleFolder">
      <Component Id="PSModuleHvbakScript" Guid="F5A6B7C8-9D0E-1F2A-3B4C-5D6E7F8A9B0C" Win64="yes">
        <File Id="PSModuleHvbakPs1" Source="hvbak.ps1" />
      </Component>
      <Component Id="PSModuleHvbakModule" Guid="A6B7C8D9-0E1F-2A3B-4C5D-6E7F8A9B0C1D" Win64="yes">
        <File Id="PSModuleHvbakPsm1" Source="hvbak.psm1" />
      </Component>
      <Component Id="PSModuleHvbakManifest" Guid="B7C8D9E0-1F2A-3B4C-5D6E-7F8A9B0C1D2E" Win64="yes">
        <File Id="PSModuleHvbakPsd1" Source="hvbak.psd1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Start Menu shortcuts -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="C8D9E0F1-2A3B-4C5D-6E7F-8A9B0C1D2E3F">
        <Shortcut Id="QuickStartShortcut"
                  Name="Quick Start Guide"
                  Description="PSHVTools Quick Start Guide"
                  Target="[INSTALLFOLDER]QUICKSTART.md"
                  WorkingDirectory="INSTALLFOLDER" />
        <Shortcut Id="UninstallShortcut"
                  Name="Uninstall PSHVTools"
                  Description="Uninstalls PSHVTools"
                  Target="[SystemFolder]msiexec.exe"
                  Arguments="/x [ProductCode]" />
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" 
                       Key="Software\PSHVTools" 
                       Name="installed" 
                       Type="integer" 
                       Value="1" 
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- UI configuration -->
    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    
    <!-- License agreement -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    
  </Product>
</Wix>
